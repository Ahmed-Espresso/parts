<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ÙˆØ±Ø´Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js Ù„Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 70px;
            color: white;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            color: white;
            transition: transform 0.2s;
            padding: 25px;
        }
        .glass-card:hover {
            transform: translateY(-5px);
        }
        .btn-glow {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 50px;
            padding: 8px 20px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-glow:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            color: white;
        }
        .product-card, .customer-card, .supplier-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 5px solid #00d4ff;
            color: white;
        }
        .product-card:hover, .customer-card:hover, .supplier-card:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        .profit-badge {
            background: #28a745;
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-weight: bold;
        }
        .nav-tabs-custom {
            border-bottom: none;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .nav-tabs-custom .nav-link {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 50px;
            padding: 12px 25px;
            font-weight: 600;
            transition: 0.3s;
        }
        .nav-tabs-custom .nav-link.active {
            background: #00d4ff;
            color: #1e3c72;
            box-shadow: 0 0 20px #00d4ff;
        }
        .search-box {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            color: white;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .table-custom {
            color: white;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        .table-custom th, .table-custom td {
            border-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
        }
        .modal-content {
            background: linear-gradient(145deg, #2a3f5e, #1b2b41);
            color: white;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-close-white {
            filter: invert(1);
        }
        .floating-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #00d4ff;
            color: #1e3c72;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,212,255,0.6);
            border: none;
            z-index: 1000;
            transition: 0.3s;
            cursor: pointer;
        }
        .floating-btn:hover {
            transform: scale(1.1);
            background: #fff;
        }
        .floating-menu {
            position: fixed;
            bottom: 150px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1001;
            border: 1px solid #00d4ff;
        }
        .floating-menu.show {
            display: flex;
        }
        .floating-menu button {
            background: transparent;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: right;
            border-radius: 10px;
            transition: 0.3s;
        }
        .floating-menu button:hover {
            background: #00d4ff;
            color: #1e3c72;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 999;
        }
        .bottom-nav a {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: 0.3s;
        }
        .bottom-nav a.active {
            color: #00d4ff;
            transform: translateY(-5px);
        }
        .bottom-nav a i {
            font-size: 22px;
            margin-bottom: 4px;
        }
        .content-section {
            display: none;
        }
        .content-section.active-section {
            display: block;
        }
        .form-control.bg-transparent {
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .form-control.bg-transparent:focus {
            background: rgba(255,255,255,0.2) !important;
            border-color: #00d4ff;
            box-shadow: none;
        }
        .form-select.bg-transparent {
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .form-select.bg-transparent option {
            background: #1e3c72;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
        }
        .chart-container {
            position: relative;
            height: 250px;
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <!-- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
    <div class="bottom-nav d-md-none">
        <a href="#" class="nav-bottom-link active" data-target="inventory-section">
            <i class="fas fa-box"></i>
            <span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        </a>
        <a href="#" class="nav-bottom-link" data-target="customers-section">
            <i class="fas fa-users"></i>
            <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
        </a>
        <a href="#" class="nav-bottom-link" data-target="suppliers-section">
            <i class="fas fa-truck"></i>
            <span>Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</span>
        </a>
        <a href="#" class="nav-bottom-link" data-target="reports-section">
            <i class="fas fa-chart-pie"></i>
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
        </a>
    </div>

    <!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø¥Ø¶Ø§ÙØ© -->
    <div class="floating-btn" id="floatingBtn">
        <i class="fas fa-plus"></i>
    </div>
    <div class="floating-menu" id="floatingMenu">
        <button onclick="showAddProductModal()"><i class="fas fa-box me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
        <button onclick="showAddCustomerModal()"><i class="fas fa-user me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
        <button onclick="showAddSupplierModal()"><i class="fas fa-truck me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
    </div>

    <div class="container py-4">
        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold"><i class="fas fa-tools me-2"></i>ÙˆØ±Ø´Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h1>
            <p class="text-white-50">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ -->
        <ul class="nav nav-tabs-custom d-none d-md-flex mb-4" id="desktopTabs">
            <li class="nav-item">
                <button class="nav-link active" data-target="inventory-section">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-target="customers-section">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-target="suppliers-section">Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-target="reports-section">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            </li>
        </ul>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
        <div id="inventory-section" class="content-section active-section">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-warehouse me-2"></i>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                    <button class="btn-glow d-none d-md-inline-block" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©..." onkeyup="searchProducts()">
                </div>
                <div id="productsList" class="row">
                    <!-- ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§ -->
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-3x"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div id="customers-section" class="content-section">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-users me-2"></i>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <button class="btn-glow" onclick="showAddCustomerModal()">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text" class="search-box" id="searchCustomerInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." onkeyup="searchCustomers()">
                </div>
                <div id="customersList" class="row">
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-3x"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† -->
        <div id="suppliers-section" class="content-section">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-truck me-2"></i>Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h3>
                    <button class="btn-glow" onclick="showAddSupplierModal()">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text" class="search-box" id="searchSupplierInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." onkeyup="searchSuppliers()">
                </div>
                <div id="suppliersList" class="row">
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-3x"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div id="reports-section" class="content-section">
            <div class="glass-card">
                <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                
                <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ -->
                <div class="row mb-4">
                    <div class="col-4">
                        <div class="stat-card">
                            <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</small>
                            <h4 id="totalProfitAll">0 Ø¬</h4>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-card">
                            <small>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</small>
                            <h4 id="totalProfitToday">0 Ø¬</h4>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-card">
                            <small>Ø£Ø±Ø¨Ø§Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</small>
                            <h4 id="totalProfitMonth">0 Ø¬</h4>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>

                <!-- Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹ -->
                <div class="mt-4">
                    <h5><i class="fas fa-fire me-2"></i>Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h5>
                    <div id="topProductsList" class="mb-4">
                        <div class="text-center py-3">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                    </div>
                </div>

                <!-- Ø¢Ø®Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
                <div>
                    <h5><i class="fas fa-history me-2"></i>Ø¢Ø®Ø± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
                    <div id="salesList">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-3x"></i>
                            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ¹ -->
    <div class="modal fade" id="sellModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sellForm" onsubmit="event.preventDefault(); confirmSell();">
                        <input type="hidden" id="sellProductId">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="text" class="form-control bg-transparent" id="sellProductName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                            <input type="text" class="form-control bg-transparent" id="sellAvailableQty" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</label>
                            <input type="number" class="form-control bg-transparent" id="sellQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <select class="form-select bg-transparent" id="sellCustomerId">
                                <option value="" selected>-- Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙŠÙ„ --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</label>
                            <input type="date" class="form-control bg-transparent" id="sellDate" required>
                        </div>
                        <button type="submit" class="btn-glow w-100">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ù…Ù†ØªØ¬ -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" onsubmit="event.preventDefault(); saveEditProduct();">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                            <input type="text" class="form-control bg-transparent" id="editName" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                                <input type="text" class="form-control bg-transparent" id="editPartNumber">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                                <input type="text" class="form-control bg-transparent" id="editVehicleModel">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
                                <input type="number" step="0.01" class="form-control bg-transparent" id="editCostPrice" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                                <input type="number" step="0.01" class="form-control bg-transparent" id="editSellingPrice" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                            <input type="number" class="form-control bg-transparent" id="editQuantity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                            <textarea class="form-control bg-transparent" id="editDescription" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCustomerForm" onsubmit="event.preventDefault(); addCustomer();">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù… *</label>
                            <input type="text" class="form-control bg-transparent" id="customerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control bg-transparent" id="customerPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <textarea class="form-control bg-transparent" id="customerAddress" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ -->
    <div class="modal fade" id="addSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-truck-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSupplierForm" onsubmit="event.preventDefault(); addSupplier();">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù… *</label>
                            <input type="text" class="form-control bg-transparent" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control bg-transparent" id="supplierPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <textarea class="form-control bg-transparent" id="supplierAddress" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <textarea class="form-control bg-transparent" id="supplierProducts" rows="2" placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙˆÙØ±Ù‡Ø§"></textarea>
                        </div>
                        <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„ -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCustomerForm" onsubmit="event.preventDefault(); saveEditCustomer();">
                        <input type="hidden" id="editCustomerId">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" class="form-control bg-transparent" id="editCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control bg-transparent" id="editCustomerPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <textarea class="form-control bg-transparent" id="editCustomerAddress" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ±Ø¯ -->
    <div class="modal fade" id="editSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ±Ø¯</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editSupplierForm" onsubmit="event.preventDefault(); saveEditSupplier();">
                        <input type="hidden" id="editSupplierId">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" class="form-control bg-transparent" id="editSupplierName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="text" class="form-control bg-transparent" id="editSupplierPhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <textarea class="form-control bg-transparent" id="editSupplierAddress" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ±Ø¯Ø©</label>
                            <textarea class="form-control bg-transparent" id="editSupplierProducts" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            // -------------------- Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB (Ø§Ù„Ø¥ØµØ¯Ø§Ø± 4 Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†) --------------------
            const DB_NAME = 'WorkshopDB';
            const DB_VERSION = 4;
            const STORE_PRODUCTS = 'products';
            const STORE_SALES = 'sales';
            const STORE_CUSTOMERS = 'customers';
            const STORE_SUPPLIERS = 'suppliers';

            let db = null;
            let modalSell, modalEdit, modalAddCustomer, modalAddSupplier, modalEditCustomer, modalEditSupplier, modalAddProduct;
            let profitChart = null;

            // ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (e) => {
                        console.error('DB error', e.target.error);
                        reject(e.target.error);
                    };
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_PRODUCTS)) {
                            const store = db.createObjectStore(STORE_PRODUCTS, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('name', 'name', { unique: false });
                        }
                        if (!db.objectStoreNames.contains(STORE_SALES)) {
                            const store = db.createObjectStore(STORE_SALES, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('productId', 'productId', { unique: false });
                            store.createIndex('saleDate', 'saleDate', { unique: false });
                            store.createIndex('customerId', 'customerId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains(STORE_CUSTOMERS)) {
                            const store = db.createObjectStore(STORE_CUSTOMERS, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('name', 'name', { unique: false });
                        }
                        if (!db.objectStoreNames.contains(STORE_SUPPLIERS)) {
                            const store = db.createObjectStore(STORE_SUPPLIERS, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('name', 'name', { unique: false });
                        }
                    };
                });
            }

            // -------------------- Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù…Ø© --------------------
            async function getAll(storeName) {
                if (!db) return [];
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, 'readonly');
                    const store = tx.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function add(storeName, item) {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.add(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function update(storeName, item) {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.put(item);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function deleteItem(storeName, id) {
                const tx = db.transaction(storeName, 'readwrite');
                const store = tx.objectStore(storeName);
                return new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // -------------------- ØªÙ‡ÙŠØ¦Ø© --------------------
            document.addEventListener('DOMContentLoaded', async () => {
                await openDB();
                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
                modalSell = new bootstrap.Modal(document.getElementById('sellModal'));
                modalEdit = new bootstrap.Modal(document.getElementById('editModal'));
                modalAddCustomer = new bootstrap.Modal(document.getElementById('addCustomerModal'));
                modalAddSupplier = new bootstrap.Modal(document.getElementById('addSupplierModal'));
                modalEditCustomer = new bootstrap.Modal(document.getElementById('editCustomerModal'));
                modalEditSupplier = new bootstrap.Modal(document.getElementById('editSupplierModal'));
                modalAddProduct = new bootstrap.Modal(document.getElementById('addProductModal'));

                // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('sellDate').value = today;

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                refreshInventory();
                refreshCustomers();
                refreshSuppliers();
                refreshReports();

                // Ø§Ù„ØªÙ†Ù‚Ù„
                setupNavigation();

                // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…
                setupFloatingButton();
            });

            function setupNavigation() {
                const bottomLinks = document.querySelectorAll('.nav-bottom-link');
                const desktopTabs = document.querySelectorAll('#desktopTabs .nav-link');

                window.setActiveSection = function(sectionId) {
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
                    document.getElementById(sectionId).classList.add('active-section');
                    if (sectionId === 'reports-section') refreshReports();
                    if (sectionId === 'inventory-section') refreshInventory();
                    if (sectionId === 'customers-section') refreshCustomers();
                    if (sectionId === 'suppliers-section') refreshSuppliers();
                };

                bottomLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = link.getAttribute('data-target');
                        setActiveSection(target);
                        bottomLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    });
                });

                desktopTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const target = tab.getAttribute('data-target');
                        setActiveSection(target);
                        desktopTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                    });
                });
            }

            function setupFloatingButton() {
                const btn = document.getElementById('floatingBtn');
                const menu = document.getElementById('floatingMenu');
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menu.classList.toggle('show');
                });
                document.addEventListener('click', () => {
                    menu.classList.remove('show');
                });
                menu.addEventListener('click', (e) => e.stopPropagation());
            }

            // -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø®Ø²ÙˆÙ†) --------------------
            window.refreshInventory = async function() {
                const products = await getAll(STORE_PRODUCTS);
                displayProducts(products);
            };

            function displayProducts(products) {
                const container = document.getElementById('productsList');
                if (!products || products.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-box-open fa-4x mb-3"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª. Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ Ø§Ù„Ø¢Ù†!</p></div>';
                    return;
                }
                let html = '';
                products.forEach(p => {
                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card">
                            <div class="d-flex justify-content-between">
                                <h5>${escapeHtml(p.name)}</h5>
                                <span class="badge bg-info">${p.quantity} Ù‚Ø·Ø¹Ø©</span>
                            </div>
                            <p class="small text-white-50 mb-1">Ø±Ù‚Ù…: ${escapeHtml(p.partNumber || 'â€”')}</p>
                            <p class="small text-white-50 mb-2">Ù…ÙˆØ¯ÙŠÙ„: ${escapeHtml(p.vehicleModel || 'â€”')}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-warning">ÙƒÙ„ÙØ©: ${p.costPrice} Ø¬</span><br>
                                    <span class="text-success">Ø¨ÙŠØ¹: ${p.sellingPrice} Ø¬</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-light" onclick="openSellModal(${p.id}, '${escapeHtml(p.name)}', ${p.quantity})"><i class="fas fa-shopping-cart"></i></button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="openEditModal(${p.id})"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProductHandler(${p.id})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }

            window.searchProducts = async function() {
                const query = document.getElementById('searchInput').value.trim().toLowerCase();
                const all = await getAll(STORE_PRODUCTS);
                if (!query) {
                    displayProducts(all);
                } else {
                    const filtered = all.filter(p => 
                        p.name.toLowerCase().includes(query) || 
                        (p.partNumber && p.partNumber.toLowerCase().includes(query))
                    );
                    displayProducts(filtered);
                }
            };

            window.showAddProductModal = function() {
                document.getElementById('addProductForm').reset();
                modalAddProduct.show();
            };

            window.addNewProduct = async function() {
                const product = {
                    name: document.getElementById('productName').value,
                    partNumber: document.getElementById('partNumber').value,
                    vehicleModel: document.getElementById('vehicleModel').value,
                    costPrice: parseFloat(document.getElementById('costPrice').value),
                    sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
                    quantity: parseInt(document.getElementById('quantity').value),
                    description: document.getElementById('description').value
                };
                await add(STORE_PRODUCTS, product);
                modalAddProduct.hide();
                refreshInventory();
                alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                setActiveSection('inventory-section');
            };

            window.openSellModal = async function(id, name, availableQty) {
                // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
                document.getElementById('sellProductId').value = id;
                document.getElementById('sellProductName').value = name;
                document.getElementById('sellAvailableQty').value = availableQty;
                document.getElementById('sellQuantity').value = 1;
                document.getElementById('sellQuantity').max = availableQty;

                // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± "Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙŠÙ„"
                const customers = await getAll(STORE_CUSTOMERS);
                const select = document.getElementById('sellCustomerId');
                select.innerHTML = '<option value="" selected>-- Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙŠÙ„ --</option>';
                customers.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${escapeHtml(c.name)}</option>`;
                });

                modalSell.show();
            };

            window.confirmSell = async function() {
                const productId = parseInt(document.getElementById('sellProductId').value);
                const qty = parseInt(document.getElementById('sellQuantity').value);
                const saleDate = document.getElementById('sellDate').value;
                const customerId = document.getElementById('sellCustomerId').value; // Ù‚Ø¯ ØªÙƒÙˆÙ† ÙØ§Ø±ØºØ© (null)

                if (!qty || qty <= 0) return alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');

                const tx = db.transaction([STORE_PRODUCTS, STORE_SALES], 'readwrite');
                const productStore = tx.objectStore(STORE_PRODUCTS);
                const product = await new Promise((res, rej) => {
                    const req = productStore.get(productId);
                    req.onsuccess = () => res(req.result);
                    req.onerror = rej;
                });

                if (!product) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                if (product.quantity < qty) return alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');

                const profit = (product.sellingPrice - product.costPrice) * qty;
                const sale = {
                    productId: product.id,
                    productName: product.name,
                    quantitySold: qty,
                    sellingPriceAtSale: product.sellingPrice,
                    costPriceAtSale: product.costPrice,
                    totalProfit: profit,
                    saleDate: saleDate,
                    customerId: customerId ? parseInt(customerId) : null  // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ®ØªØ± Ø¹Ù…ÙŠÙ„Ø§Ù‹ØŒ ÙŠØ®Ø²Ù† null
                };

                // ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬
                product.quantity -= qty;
                await new Promise((res, rej) => {
                    const req = productStore.put(product);
                    req.onsuccess = res;
                    req.onerror = rej;
                });

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ¹
                const saleStore = tx.objectStore(STORE_SALES);
                await new Promise((res, rej) => {
                    const req = saleStore.add(sale);
                    req.onsuccess = res;
                    req.onerror = rej;
                });

                await tx.done;

                modalSell.hide();
                refreshInventory();
                refreshReports();
            };

            window.openEditModal = async function(id) {
                const tx = db.transaction(STORE_PRODUCTS, 'readonly');
                const store = tx.objectStore(STORE_PRODUCTS);
                const product = await new Promise((res) => {
                    const req = store.get(id);
                    req.onsuccess = () => res(req.result);
                });
                if (product) {
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('editName').value = product.name;
                    document.getElementById('editPartNumber').value = product.partNumber || '';
                    document.getElementById('editVehicleModel').value = product.vehicleModel || '';
                    document.getElementById('editCostPrice').value = product.costPrice;
                    document.getElementById('editSellingPrice').value = product.sellingPrice;
                    document.getElementById('editQuantity').value = product.quantity;
                    document.getElementById('editDescription').value = product.description || '';
                    modalEdit.show();
                }
            };

            window.saveEditProduct = async function() {
                const id = parseInt(document.getElementById('editProductId').value);
                const updated = {
                    id: id,
                    name: document.getElementById('editName').value,
                    partNumber: document.getElementById('editPartNumber').value,
                    vehicleModel: document.getElementById('editVehicleModel').value,
                    costPrice: parseFloat(document.getElementById('editCostPrice').value),
                    sellingPrice: parseFloat(document.getElementById('editSellingPrice').value),
                    quantity: parseInt(document.getElementById('editQuantity').value),
                    description: document.getElementById('editDescription').value
                };
                await update(STORE_PRODUCTS, updated);
                modalEdit.hide();
                refreshInventory();
            };

            window.deleteProductHandler = async function(id) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                    await deleteItem(STORE_PRODUCTS, id);
                    refreshInventory();
                }
            };

            // -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ --------------------
            window.refreshCustomers = async function() {
                const customers = await getAll(STORE_CUSTOMERS);
                displayCustomers(customers);
            };

            function displayCustomers(customers) {
                const container = document.getElementById('customersList');
                if (!customers || customers.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-user-slash fa-4x mb-3"></i><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡. Ø£Ø¶Ù Ø¹Ù…ÙŠÙ„Ø§Ù‹ Ø§Ù„Ø¢Ù†!</p></div>';
                    return;
                }
                let html = '';
                customers.forEach(c => {
                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="customer-card">
                            <div class="d-flex justify-content-between">
                                <h5>${escapeHtml(c.name)}</h5>
                                <span><i class="fas fa-phone"></i> ${escapeHtml(c.phone || 'â€”')}</span>
                            </div>
                            <p class="small text-white-50 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${escapeHtml(c.address || 'â€”')}</p>
                            <div class="d-flex justify-content-between">
                                <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª: <span class="text-info">0 Ø¬</span></span> <!-- ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ -->
                                <div>
                                    <button class="btn btn-sm btn-outline-warning" onclick="openEditCustomerModal(${c.id})"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomerHandler(${c.id})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }

            window.searchCustomers = async function() {
                const query = document.getElementById('searchCustomerInput').value.trim().toLowerCase();
                const all = await getAll(STORE_CUSTOMERS);
                if (!query) {
                    displayCustomers(all);
                } else {
                    const filtered = all.filter(c => 
                        c.name.toLowerCase().includes(query) || 
                        (c.phone && c.phone.includes(query))
                    );
                    displayCustomers(filtered);
                }
            };

            window.showAddCustomerModal = function() {
                document.getElementById('addCustomerForm').reset();
                modalAddCustomer.show();
            };

            window.addCustomer = async function() {
                const customer = {
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    address: document.getElementById('customerAddress').value
                };
                await add(STORE_CUSTOMERS, customer);
                modalAddCustomer.hide();
                refreshCustomers();
            };

            window.openEditCustomerModal = async function(id) {
                const tx = db.transaction(STORE_CUSTOMERS, 'readonly');
                const store = tx.objectStore(STORE_CUSTOMERS);
                const customer = await new Promise((res) => {
                    const req = store.get(id);
                    req.onsuccess = () => res(req.result);
                });
                if (customer) {
                    document.getElementById('editCustomerId').value = customer.id;
                    document.getElementById('editCustomerName').value = customer.name;
                    document.getElementById('editCustomerPhone').value = customer.phone || '';
                    document.getElementById('editCustomerAddress').value = customer.address || '';
                    modalEditCustomer.show();
                }
            };

            window.saveEditCustomer = async function() {
                const id = parseInt(document.getElementById('editCustomerId').value);
                const updated = {
                    id: id,
                    name: document.getElementById('editCustomerName').value,
                    phone: document.getElementById('editCustomerPhone').value,
                    address: document.getElementById('editCustomerAddress').value
                };
                await update(STORE_CUSTOMERS, updated);
                modalEditCustomer.hide();
                refreshCustomers();
            };

            window.deleteCustomerHandler = async function(id) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) {
                    await deleteItem(STORE_CUSTOMERS, id);
                    refreshCustomers();
                }
            };

            // -------------------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† --------------------
            window.refreshSuppliers = async function() {
                const suppliers = await getAll(STORE_SUPPLIERS);
                displaySuppliers(suppliers);
            };

            function displaySuppliers(suppliers) {
                const container = document.getElementById('suppliersList');
                if (!suppliers || suppliers.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-truck-slash fa-4x mb-3"></i><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ±Ø¯ÙŠÙ†. Ø£Ø¶Ù Ù…ÙˆØ±Ø¯Ø§Ù‹ Ø§Ù„Ø¢Ù†!</p></div>';
                    return;
                }
                let html = '';
                suppliers.forEach(s => {
                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="supplier-card">
                            <div class="d-flex justify-content-between">
                                <h5>${escapeHtml(s.name)}</h5>
                                <span><i class="fas fa-phone"></i> ${escapeHtml(s.phone || 'â€”')}</span>
                            </div>
                            <p class="small text-white-50 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${escapeHtml(s.address || 'â€”')}</p>
                            <p class="small text-white-50">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${escapeHtml(s.products || 'â€”')}</p>
                            <div class="d-flex justify-content-between">
                                <div></div>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning" onclick="openEditSupplierModal(${s.id})"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplierHandler(${s.id})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }

            window.searchSuppliers = async function() {
                const query = document.getElementById('searchSupplierInput').value.trim().toLowerCase();
                const all = await getAll(STORE_SUPPLIERS);
                if (!query) {
                    displaySuppliers(all);
                } else {
                    const filtered = all.filter(s => 
                        s.name.toLowerCase().includes(query) || 
                        (s.phone && s.phone.includes(query))
                    );
                    displaySuppliers(filtered);
                }
            };

            window.showAddSupplierModal = function() {
                document.getElementById('addSupplierForm').reset();
                modalAddSupplier.show();
            };

            window.addSupplier = async function() {
                const supplier = {
                    name: document.getElementById('supplierName').value,
                    phone: document.getElementById('supplierPhone').value,
                    address: document.getElementById('supplierAddress').value,
                    products: document.getElementById('supplierProducts').value
                };
                await add(STORE_SUPPLIERS, supplier);
                modalAddSupplier.hide();
                refreshSuppliers();
            };

            window.openEditSupplierModal = async function(id) {
                const tx = db.transaction(STORE_SUPPLIERS, 'readonly');
                const store = tx.objectStore(STORE_SUPPLIERS);
                const supplier = await new Promise((res) => {
                    const req = store.get(id);
                    req.onsuccess = () => res(req.result);
                });
                if (supplier) {
                    document.getElementById('editSupplierId').value = supplier.id;
                    document.getElementById('editSupplierName').value = supplier.name;
                    document.getElementById('editSupplierPhone').value = supplier.phone || '';
                    document.getElementById('editSupplierAddress').value = supplier.address || '';
                    document.getElementById('editSupplierProducts').value = supplier.products || '';
                    modalEditSupplier.show();
                }
            };

            window.saveEditSupplier = async function() {
                const id = parseInt(document.getElementById('editSupplierId').value);
                const updated = {
                    id: id,
                    name: document.getElementById('editSupplierName').value,
                    phone: document.getElementById('editSupplierPhone').value,
                    address: document.getElementById('editSupplierAddress').value,
                    products: document.getElementById('editSupplierProducts').value
                };
                await update(STORE_SUPPLIERS, updated);
                modalEditSupplier.hide();
                refreshSuppliers();
            };

            window.deleteSupplierHandler = async function(id) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯ØŸ')) {
                    await deleteItem(STORE_SUPPLIERS, id);
                    refreshSuppliers();
                }
            };

            // -------------------- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± --------------------
            window.refreshReports = async function() {
                const sales = await getAll(STORE_SALES);
                displaySales(sales);
                calculateTotals(sales);
                updateChart(sales);
                displayTopProducts(sales);
            };

            function displaySales(sales) {
                const container = document.getElementById('salesList');
                if (!sales || sales.length === 0) {
                    container.innerHTML = '<div class="text-center py-4"><i class="fas fa-receipt fa-4x mb-3"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</p></div>';
                    return;
                }
                sales.sort((a, b) => new Date(b.saleDate) - new Date(a.saleDate));
                let html = '<div class="table-responsive"><table class="table table-custom"><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø±Ø¨Ø­</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>';
                sales.slice(0, 10).forEach(s => {
                    html += `<tr><td>${escapeHtml(s.productName)}</td><td>${s.quantitySold}</td><td class="text-success">${s.totalProfit} Ø¬</td><td>${s.saleDate}</td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            function calculateTotals(sales) {
                let totalAll = 0;
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                let totalToday = 0;
                let totalMonth = 0;
                sales.forEach(s => {
                    totalAll += s.totalProfit;
                    if (s.saleDate === today) totalToday += s.totalProfit;
                    const saleDate = new Date(s.saleDate);
                    if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) totalMonth += s.totalProfit;
                });
                document.getElementById('totalProfitAll').innerText = totalAll + ' Ø¬';
                document.getElementById('totalProfitToday').innerText = totalToday + ' Ø¬';
                document.getElementById('totalProfitMonth').innerText = totalMonth + ' Ø¬';
            }

            function updateChart(sales) {
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù„Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
                const last7Days = [];
                const labels = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    labels.push(dateStr);
                    last7Days.push(dateStr);
                }
                const data = last7Days.map(date => {
                    return sales.filter(s => s.saleDate === date).reduce((acc, s) => acc + s.totalProfit, 0);
                });

                const ctx = document.getElementById('profitChart').getContext('2d');
                if (profitChart) profitChart.destroy();
                profitChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ø¬)',
                            data: data,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0,212,255,0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: 'white' } }
                        },
                        scales: {
                            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        }
                    }
                });
            }

            function displayTopProducts(sales) {
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØªØ¬
                const productSales = {};
                sales.forEach(s => {
                    if (!productSales[s.productId]) {
                        productSales[s.productId] = { name: s.productName, quantity: 0, profit: 0 };
                    }
                    productSales[s.productId].quantity += s.quantitySold;
                    productSales[s.productId].profit += s.totalProfit;
                });
                const sorted = Object.values(productSales).sort((a, b) => b.quantity - a.quantity).slice(0, 5);
                let html = '<div class="row">';
                sorted.forEach(p => {
                    html += `
                    <div class="col-6 mb-2">
                        <div class="bg-dark bg-opacity-25 p-2 rounded">
                            <strong>${escapeHtml(p.name)}</strong><br>
                            <small>Ø§Ù„ÙƒÙ…ÙŠØ©: ${p.quantity} | Ø§Ù„Ø±Ø¨Ø­: ${p.profit} Ø¬</small>
                        </div>
                    </div>`;
                });
                html += '</div>';
                document.getElementById('topProductsList').innerHTML = html || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</p>';
            }

            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù‡Ø±ÙˆØ¨ Ù…Ù† HTML
            function escapeHtml(unsafe) {
                if (!unsafe) return unsafe;
                return unsafe.replace(/[&<>"']/g, function(m) {
                    if (m === '&') return '&amp;';
                    if (m === '<') return '&lt;';
                    if (m === '>') return '&gt;';
                    if (m === '"') return '&quot;';
                    if (m === "'") return '&#039;';
                    return m;
                });
            }

            // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
            const addProductModalHTML = `
            <div class="modal fade" id="addProductModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addProductForm" onsubmit="event.preventDefault(); addNewProduct();">
                                <div class="mb-3">
                                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© *</label>
                                    <input type="text" class="form-control bg-transparent" id="productName" required>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                                        <input type="text" class="form-control bg-transparent" id="partNumber">
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                                        <input type="text" class="form-control bg-transparent" id="vehicleModel">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© *</label>
                                        <input type="number" step="0.01" class="form-control bg-transparent" id="costPrice" required>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label>
                                        <input type="number" step="0.01" class="form-control bg-transparent" id="sellingPrice" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© *</label>
                                    <input type="number" class="form-control bg-transparent" id="quantity" value="1" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                    <textarea class="form-control bg-transparent" id="description" rows="2"></textarea>
                                </div>
                                <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            `;
            document.body.insertAdjacentHTML('beforeend', addProductModalHTML);

        })();
    </script>
</body>
</html>