<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ÙˆØ±Ø´Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø± - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯Ø© */
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 70px;
            color: white;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            color: white;
            transition: transform 0.2s;
            padding: 25px;
        }
        .glass-card:hover {
            transform: translateY(-5px);
        }
        .btn-glow {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 50px;
            padding: 8px 20px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-glow:hover {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            color: white;
        }
        .product-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 5px solid #00d4ff;
            color: white;
        }
        .product-card:hover {
            background: rgba(0, 0, 0, 0.5);
        }
        .profit-badge {
            background: #28a745;
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-weight: bold;
        }
        .nav-tabs-custom {
            border-bottom: none;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        .nav-tabs-custom .nav-link {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 50px;
            padding: 12px 25px;
            font-weight: 600;
            transition: 0.3s;
        }
        .nav-tabs-custom .nav-link.active {
            background: #00d4ff;
            color: #1e3c72;
            box-shadow: 0 0 20px #00d4ff;
        }
        .search-box {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            color: white;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .table-custom {
            color: white;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        .table-custom th, .table-custom td {
            border-color: rgba(255, 255, 255, 0.1);
            padding: 12px;
        }
        .modal-content {
            background: linear-gradient(145deg, #2a3f5e, #1b2b41);
            color: white;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-close-white {
            filter: invert(1);
        }
        .floating-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #00d4ff;
            color: #1e3c72;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,212,255,0.6);
            border: none;
            z-index: 1000;
            transition: 0.3s;
        }
        .floating-btn:hover {
            transform: scale(1.1);
            background: #fff;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 999;
        }
        .bottom-nav a {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: 0.3s;
        }
        .bottom-nav a.active {
            color: #00d4ff;
            transform: translateY(-5px);
        }
        .bottom-nav a i {
            font-size: 22px;
            margin-bottom: 4px;
        }
        .content-section {
            display: none;
        }
        .content-section.active-section {
            display: block;
        }
        .form-control.bg-transparent {
            background: rgba(255,255,255,0.1) !important;
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .form-control.bg-transparent:focus {
            background: rgba(255,255,255,0.2) !important;
            border-color: #00d4ff;
            box-shadow: none;
        }
    </style>
</head>
<body>

    <!-- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
    <div class="bottom-nav d-md-none">
        <a href="#" class="nav-bottom-link active" data-target="inventory-section">
            <i class="fas fa-box"></i>
            <span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        </a>
        <a href="#" class="nav-bottom-link" data-target="profit-section">
            <i class="fas fa-chart-line"></i>
            <span>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span>
        </a>
        <a href="#" class="nav-bottom-link" data-target="add-section">
            <i class="fas fa-plus-circle"></i>
            <span>Ø¥Ø¶Ø§ÙØ©</span>
        </a>
    </div>

    <!-- Ø²Ø± Ø¹Ø§Ø¦Ù… Ù„Ù„Ø¥Ø¶Ø§ÙØ© (Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
    <button class="floating-btn d-md-none" onclick="showAddSection()">
        <i class="fas fa-plus"></i>
    </button>

    <div class="container py-4">
        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <div class="text-center mb-4">
            <h1 class="display-5 fw-bold"><i class="fas fa-tools me-2"></i>ÙˆØ±Ø´Ø© Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±</h1>
            <p class="text-white-50">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨ÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª</p>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ -->
        <ul class="nav nav-tabs-custom d-none d-md-flex mb-4" id="desktopTabs">
            <li class="nav-item">
                <button class="nav-link active" data-target="inventory-section">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-target="profit-section">Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-target="add-section">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
            </li>
        </ul>

        <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
        <div id="inventory-section" class="content-section active-section">
            <div class="glass-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-warehouse me-2"></i>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                    <button class="btn-glow d-none d-md-inline-block" onclick="showAddSection()">
                        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>
                <div class="mb-3">
                    <input type="text" class="search-box" id="searchInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©..." onkeyup="searchProducts()">
                </div>
                <div id="productsList" class="row">
                    <!-- ØªØ¸Ù‡Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§ -->
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-3x"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="profit-section" class="content-section">
            <div class="glass-card">
                <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</h3>
                <div class="row mb-4">
                    <div class="col-6">
                        <div class="bg-success bg-opacity-25 p-3 rounded-3 text-center">
                            <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</small>
                            <h2 id="totalProfitAll">0 Ø¬</h2>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-info bg-opacity-25 p-3 rounded-3 text-center">
                            <small>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</small>
                            <h2 id="totalProfitToday">0 Ø¬</h2>
                        </div>
                    </div>
                </div>
                <div id="salesList">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-3x"></i>
                        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="add-section" class="content-section">
            <div class="glass-card">
                <h3 class="mb-4"><i class="fas fa-plus-circle me-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="addProductForm" onsubmit="event.preventDefault(); addNewProduct();">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø© *</label>
                        <input type="text" class="form-control bg-transparent" id="productName" required>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                            <input type="text" class="form-control bg-transparent" id="partNumber">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                            <input type="text" class="form-control bg-transparent" id="vehicleModel">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© *</label>
                            <input type="number" step="0.01" class="form-control bg-transparent" id="costPrice" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ *</label>
                            <input type="number" step="0.01" class="form-control bg-transparent" id="sellingPrice" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© *</label>
                        <input type="number" class="form-control bg-transparent" id="quantity" value="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea class="form-control bg-transparent" id="description" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ¹ -->
    <div class="modal fade" id="sellModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sellForm" onsubmit="event.preventDefault(); confirmSell();">
                        <input type="hidden" id="sellProductId">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="text" class="form-control bg-transparent" id="sellProductName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
                            <input type="text" class="form-control bg-transparent" id="sellAvailableQty" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</label>
                            <input type="number" class="form-control bg-transparent" id="sellQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹</label>
                            <input type="date" class="form-control bg-transparent" id="sellDate" required>
                        </div>
                        <button type="submit" class="btn-glow w-100">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm" onsubmit="event.preventDefault(); saveEditProduct();">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                            <input type="text" class="form-control bg-transparent" id="editName" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</label>
                                <input type="text" class="form-control bg-transparent" id="editPartNumber">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                                <input type="text" class="form-control bg-transparent" id="editVehicleModel">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
                                <input type="number" step="0.01" class="form-control bg-transparent" id="editCostPrice" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
                                <input type="number" step="0.01" class="form-control bg-transparent" id="editSellingPrice" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                            <input type="number" class="form-control bg-transparent" id="editQuantity" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                            <textarea class="form-control bg-transparent" id="editDescription" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn-glow w-100">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            // -------------------- Ø¥Ø¹Ø¯Ø§Ø¯ IndexedDB --------------------
            const DB_NAME = 'WorkshopDB';
            const DB_VERSION = 3;
            const STORE_PRODUCTS = 'products';
            const STORE_SALES = 'sales';

            let db = null;
            let modalSell, modalEdit;

            // ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (e) => {
                        console.error('DB error', e.target.error);
                        reject(e.target.error);
                    };
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_PRODUCTS)) {
                            const store = db.createObjectStore(STORE_PRODUCTS, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('name', 'name', { unique: false });
                        }
                        if (!db.objectStoreNames.contains(STORE_SALES)) {
                            const store = db.createObjectStore(STORE_SALES, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('productId', 'productId', { unique: false });
                            store.createIndex('saleDate', 'saleDate', { unique: false });
                        }
                    };
                });
            }

            // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            async function getAllProducts() {
                if (!db) return [];
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_PRODUCTS, 'readonly');
                    const store = tx.objectStore(STORE_PRODUCTS);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function addProduct(product) {
                const tx = db.transaction(STORE_PRODUCTS, 'readwrite');
                const store = tx.objectStore(STORE_PRODUCTS);
                return new Promise((resolve, reject) => {
                    const request = store.add(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function updateProduct(product) {
                const tx = db.transaction(STORE_PRODUCTS, 'readwrite');
                const store = tx.objectStore(STORE_PRODUCTS);
                return new Promise((resolve, reject) => {
                    const request = store.put(product);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function deleteProduct(id) {
                const tx = db.transaction(STORE_PRODUCTS, 'readwrite');
                const store = tx.objectStore(STORE_PRODUCTS);
                return new Promise((resolve, reject) => {
                    const request = store.delete(id);
                    request.onsuccess = () => resolve();
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            async function getAllSales() {
                if (!db) return [];
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_SALES, 'readonly');
                    const store = tx.objectStore(STORE_SALES);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function addSale(sale) {
                const tx = db.transaction(STORE_SALES, 'readwrite');
                const store = tx.objectStore(STORE_SALES);
                return new Promise((resolve, reject) => {
                    const request = store.add(sale);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            // -------------------- ØªÙ‡ÙŠØ¦Ø© --------------------
            document.addEventListener('DOMContentLoaded', async () => {
                await openDB();
                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
                modalSell = new bootstrap.Modal(document.getElementById('sellModal'));
                modalEdit = new bootstrap.Modal(document.getElementById('editModal'));

                // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ¹
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('sellDate').value = today;

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©)
                refreshInventory();
                refreshProfit();

                // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„ØªÙ†Ù‚Ù„ (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨)
                setupNavigation();
            });

            // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„
            function setupNavigation() {
                // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ
                const bottomLinks = document.querySelectorAll('.nav-bottom-link');
                bottomLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = link.getAttribute('data-target');
                        setActiveSection(target);
                        bottomLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    });
                });

                // ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
                const desktopTabs = document.querySelectorAll('#desktopTabs .nav-link');
                desktopTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const target = tab.getAttribute('data-target');
                        setActiveSection(target);
                        desktopTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                    });
                });
            }

            function setActiveSection(sectionId) {
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section'));
                document.getElementById(sectionId).classList.add('active-section');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
                if (sectionId === 'profit-section') refreshProfit();
                if (sectionId === 'inventory-section') refreshInventory();
            }

            // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
            window.showAddSection = function() {
                setActiveSection('add-section');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ©
                document.querySelectorAll('.nav-bottom-link').forEach(l => l.classList.remove('active'));
                document.querySelector('.nav-bottom-link[data-target="add-section"]')?.classList.add('active');
            };

            // -------------------- Ø§Ù„Ù…Ø®Ø²ÙˆÙ† --------------------
            window.refreshInventory = async function() {
                const products = await getAllProducts();
                displayProducts(products);
            };

            function displayProducts(products) {
                const container = document.getElementById('productsList');
                if (!products || products.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-box-open fa-4x mb-3"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª. Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Ù‹ Ø§Ù„Ø¢Ù†!</p></div>';
                    return;
                }
                let html = '';
                products.forEach(p => {
                    html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="product-card">
                            <div class="d-flex justify-content-between">
                                <h5>${p.name}</h5>
                                <span class="badge bg-info">${p.quantity} Ù‚Ø·Ø¹Ø©</span>
                            </div>
                            <p class="small text-white-50 mb-1">Ø±Ù‚Ù…: ${p.partNumber || 'â€”'}</p>
                            <p class="small text-white-50 mb-2">Ù…ÙˆØ¯ÙŠÙ„: ${p.vehicleModel || 'â€”'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-warning">ÙƒÙ„ÙØ©: ${p.costPrice} Ø¬</span><br>
                                    <span class="text-success">Ø¨ÙŠØ¹: ${p.sellingPrice} Ø¬</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-light" onclick="openSellModal(${p.id}, '${p.name}', ${p.quantity})"><i class="fas fa-shopping-cart"></i></button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="openEditModal(${p.id})"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProductHandler(${p.id})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            }

            window.searchProducts = async function() {
                const query = document.getElementById('searchInput').value.trim().toLowerCase();
                const all = await getAllProducts();
                if (!query) {
                    displayProducts(all);
                } else {
                    const filtered = all.filter(p => 
                        p.name.toLowerCase().includes(query) || 
                        (p.partNumber && p.partNumber.toLowerCase().includes(query))
                    );
                    displayProducts(filtered);
                }
            };

            // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
            window.addNewProduct = async function() {
                const product = {
                    name: document.getElementById('productName').value,
                    partNumber: document.getElementById('partNumber').value,
                    vehicleModel: document.getElementById('vehicleModel').value,
                    costPrice: parseFloat(document.getElementById('costPrice').value),
                    sellingPrice: parseFloat(document.getElementById('sellingPrice').value),
                    quantity: parseInt(document.getElementById('quantity').value),
                    description: document.getElementById('description').value
                };
                await addProduct(product);
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('addProductForm').reset();
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
                // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†
                setActiveSection('inventory-section');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                refreshInventory();
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ©
                document.querySelectorAll('.nav-bottom-link').forEach(l => l.classList.remove('active'));
                document.querySelector('.nav-bottom-link[data-target="inventory-section"]')?.classList.add('active');
            };

            // Ø¨ÙŠØ¹
            window.openSellModal = function(id, name, availableQty) {
                document.getElementById('sellProductId').value = id;
                document.getElementById('sellProductName').value = name;
                document.getElementById('sellAvailableQty').value = availableQty;
                document.getElementById('sellQuantity').value = 1;
                document.getElementById('sellQuantity').max = availableQty;
                modalSell.show();
            };

            window.confirmSell = async function() {
                const productId = parseInt(document.getElementById('sellProductId').value);
                const qty = parseInt(document.getElementById('sellQuantity').value);
                const saleDate = document.getElementById('sellDate').value;

                if (!qty || qty <= 0) return alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');

                const tx = db.transaction([STORE_PRODUCTS, STORE_SALES], 'readwrite');
                const productStore = tx.objectStore(STORE_PRODUCTS);
                const product = await new Promise((res, rej) => {
                    const req = productStore.get(productId);
                    req.onsuccess = () => res(req.result);
                    req.onerror = rej;
                });

                if (!product) return alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                if (product.quantity < qty) return alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©');

                const profit = (product.sellingPrice - product.costPrice) * qty;
                const sale = {
                    productId: product.id,
                    productName: product.name,
                    quantitySold: qty,
                    sellingPriceAtSale: product.sellingPrice,
                    costPriceAtSale: product.costPrice,
                    totalProfit: profit,
                    saleDate: saleDate
                };

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©
                product.quantity -= qty;
                await new Promise((res, rej) => {
                    const req = productStore.put(product);
                    req.onsuccess = res;
                    req.onerror = rej;
                });

                // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ¹
                const saleStore = tx.objectStore(STORE_SALES);
                await new Promise((res, rej) => {
                    const req = saleStore.add(sale);
                    req.onsuccess = res;
                    req.onerror = rej;
                });

                await tx.done;

                modalSell.hide();
                refreshInventory();
                refreshProfit();
            };

            // ØªØ¹Ø¯ÙŠÙ„
            window.openEditModal = async function(id) {
                const tx = db.transaction(STORE_PRODUCTS, 'readonly');
                const store = tx.objectStore(STORE_PRODUCTS);
                const product = await new Promise((res) => {
                    const req = store.get(id);
                    req.onsuccess = () => res(req.result);
                });
                if (product) {
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('editName').value = product.name;
                    document.getElementById('editPartNumber').value = product.partNumber || '';
                    document.getElementById('editVehicleModel').value = product.vehicleModel || '';
                    document.getElementById('editCostPrice').value = product.costPrice;
                    document.getElementById('editSellingPrice').value = product.sellingPrice;
                    document.getElementById('editQuantity').value = product.quantity;
                    document.getElementById('editDescription').value = product.description || '';
                    modalEdit.show();
                }
            };

            window.saveEditProduct = async function() {
                const id = parseInt(document.getElementById('editProductId').value);
                const updated = {
                    id: id,
                    name: document.getElementById('editName').value,
                    partNumber: document.getElementById('editPartNumber').value,
                    vehicleModel: document.getElementById('editVehicleModel').value,
                    costPrice: parseFloat(document.getElementById('editCostPrice').value),
                    sellingPrice: parseFloat(document.getElementById('editSellingPrice').value),
                    quantity: parseInt(document.getElementById('editQuantity').value),
                    description: document.getElementById('editDescription').value
                };
                await updateProduct(updated);
                modalEdit.hide();
                refreshInventory();
            };

            // Ø­Ø°Ù
            window.deleteProductHandler = async function(id) {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                    await deleteProduct(id);
                    refreshInventory();
                }
            };

            // -------------------- Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ --------------------
            window.refreshProfit = async function() {
                const sales = await getAllSales();
                displaySales(sales);
                calculateTotals(sales);
            };

            function displaySales(sales) {
                const container = document.getElementById('salesList');
                if (!sales || sales.length === 0) {
                    container.innerHTML = '<div class="text-center py-4"><i class="fas fa-receipt fa-4x mb-3"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø¨Ø¹Ø¯</p></div>';
                    return;
                }
                sales.sort((a, b) => new Date(b.saleDate) - new Date(a.saleDate));
                let html = '<div class="table-responsive"><table class="table table-custom"><thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø±Ø¨Ø­</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody>';
                sales.forEach(s => {
                    html += `<tr><td>${s.productName}</td><td>${s.quantitySold}</td><td class="text-success">${s.totalProfit} Ø¬</td><td>${s.saleDate}</td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            function calculateTotals(sales) {
                let totalAll = 0;
                const today = new Date().toISOString().split('T')[0];
                let totalToday = 0;
                sales.forEach(s => {
                    totalAll += s.totalProfit;
                    if (s.saleDate === today) totalToday += s.totalProfit;
                });
                document.getElementById('totalProfitAll').innerText = totalAll + ' Ø¬';
                document.getElementById('totalProfitToday').innerText = totalToday + ' Ø¬';
            }

        })();
    </script>
</body>
</html>